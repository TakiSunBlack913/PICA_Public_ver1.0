import flet as ft
import os
import numpy as np
import pickle
import face_recognition
from PIL import Image
from io import BytesIO
from collections import defaultdict
#import time # å‡¦ç†æ™‚é–“è¨ˆæ¸¬ç”¨
import datetime
import base64 # ğŸš¨ æ–°è¦è¿½åŠ : Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ç”¨

# --- 1. è¨­å®š ---
# ğŸš¨ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’ã“ã“ã«è¨­å®šã—ã¦ãã ã•ã„ï¼
PROJECT_ROOT = os.path.dirname(os.path.abspath(__file__)) 

MODEL_FILE = os.path.join(PROJECT_ROOT, "face_classifier_model.pkl")
CONFIDENCE_THRESHOLD = 0.70 

# --- 2. ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ ---
def load_model():
    """ãƒ¢ãƒ‡ãƒ«ã¨ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã€æ­£å¸¸æ€§ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†"""
    try:
        # PROJECT_ROOTã‹ã‚‰MODEL_FILEã¸ã®ãƒ‘ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        # print(f"ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: {MODEL_FILE}")
        with open(MODEL_FILE, 'rb') as f:
            (clf, le) = pickle.load(f)
        return clf, le
    except FileNotFoundError:
        print(f"ğŸš¨ ã‚¨ãƒ©ãƒ¼: ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {MODEL_FILE}")
        return None, None
    except Exception as e:
        print(f"ğŸš¨ ã‚¨ãƒ©ãƒ¼: ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return None, None

clf, le = load_model()


# --- 3. ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã®å®šç¾© (Fletã®ãƒ¡ã‚¤ãƒ³é–¢æ•°) ---

def main(page: ft.Page):
    page.title = "ğŸ‘¤ é¡”ç”»åƒã‚½ãƒ¼ãƒˆï¼†è­˜åˆ¥ã‚¢ãƒ—ãƒª (Flet)"
    page.vertical_alignment = ft.MainAxisAlignment.START
    page.scroll = ft.ScrollMode.AUTO
    
    # è­˜åˆ¥çµæœã®è¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠ
    results_container = ft.Column(scroll=ft.ScrollMode.AUTO, expand=True)

    # ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if clf is None:
        page.add(ft.Text("ğŸš¨ ã‚¨ãƒ©ãƒ¼: ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ç ´æã—ã¦ã„ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", 
                         color=ft.Colors.RED_700, size=20))
        page.update()
        return

    # --- 4. è­˜åˆ¥å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ ---
    
    def identify_faces(image_np, uploaded_file_name):
        """ç”»åƒå†…ã®å…¨ã¦ã®é¡”ã‚’æ¤œå‡ºã—ã€è­˜åˆ¥å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ (Streamlitç‰ˆã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç§»æ¤)"""
        results_list = []
        
        # ãƒ¢ãƒ‡ãƒ«ã®å¼•æ•°ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®'hog'ã«å›ºå®š
        face_locations = face_recognition.face_locations(image_np, model="hog")
        encodings = face_recognition.face_encodings(image_np, face_locations)

        # è¤‡æ•°é¡”ã‚’å‡¦ç†ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯...
        if len(encodings) > 0:
            for face_encoding, face_location in zip(encodings, face_locations):
                test_encoding = face_encoding.reshape(1, -1)
                probabilities = clf.predict_proba(test_encoding)[0]
                max_proba = np.max(probabilities)
                max_index = np.argmax(probabilities)
                
                if max_proba >= CONFIDENCE_THRESHOLD:
                    predicted_name = le.inverse_transform(np.array([max_index]))[0]
                else:
                    predicted_name = "Unknown"
                    
                results_list.append({
                    'ãƒ•ã‚¡ã‚¤ãƒ«å': uploaded_file_name,
                    'äººç‰©å': predicted_name,
                    'ä¿¡é ¼åº¦': max_proba,
                    'ç”»åƒãƒ‡ãƒ¼ã‚¿': image_np,
                    'é¡”åº§æ¨™': face_location
                })
        else:
            results_list.append({
                'ãƒ•ã‚¡ã‚¤ãƒ«å': uploaded_file_name,
                'äººç‰©å': "Unknown (No Face)",
                'ä¿¡é ¼åº¦': 0.0,
                'ç”»åƒãƒ‡ãƒ¼ã‚¿': image_np,
                'é¡”åº§æ¨™': None
            })
        return results_list


    # --- 5. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† ---
    
    def file_picker_result(e: ft.FilePickerResultEvent):
        # ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€e.filesã®ãƒã‚§ãƒƒã‚¯ã§ååˆ†
        if not e.files:
            return
        
        # ğŸš¨ ä¿®æ­£: global time ã¨ import time ã¯å‰Šé™¤æ¸ˆã¿
        
        start_time = datetime.datetime.now()
        results_container.controls.clear()
        results_container.controls.append(ft.ProgressBar(width=400))
        page.update()
        
        all_results = []
        total_files = len(e.files)
        
        for i, file in enumerate(e.files):
            
            file_path = file.path if file.path else None 
            file_name = file.name if file.name else "Unknown File"

            if file_path is None:
                results_container.controls.append(
                    ft.Text(f"âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ« {file_name} ã®ãƒ‘ã‚¹ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚", color=ft.Colors.ORANGE_500)
                )
                continue 
                
            try:
                # ãƒ†ãƒ³ãƒãƒ©ãƒªãƒ‘ã‚¹ file_path ã‚’ä½¿ã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
                with open(file_path, "rb") as f:
                    image_bytes = f.read()
                
                # PILã¨numpyã§å‡¦ç†å¯èƒ½ãªå½¢å¼ã«å¤‰æ›
                image_pil = Image.open(BytesIO(image_bytes)).convert('RGB')
                image_np = np.array(image_pil)
                
                # è­˜åˆ¥å‡¦ç†ã‚’å®Ÿè¡Œ
                results_for_file = identify_faces(image_np, file_name)
                all_results.extend(results_for_file)
                
                # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–°
                if results_container.controls and isinstance(results_container.controls[0], ft.ProgressBar):
                     results_container.controls[0].value = (i + 1) / total_files
                     page.update()
                
            except Exception as ex:
                results_container.controls.append(
                    ft.Text(f"âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ« {file.name} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {ex}", color=ft.Colors.ORANGE_500)
                )
                page.update()
        
        # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’å‰Šé™¤
        if results_container.controls and isinstance(results_container.controls[0], ft.ProgressBar):
            results_container.controls.pop(0) 
        
        # --- 6. çµæœè¡¨ç¤ºï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ï¼‰ ---
        
        grouped_results = defaultdict(list)
        for result in all_results:
            result['ä¿¡é ¼åº¦_str'] = f"{result['ä¿¡é ¼åº¦']*100:.2f}%" if result['äººç‰©å'] not in ["Unknown (No Face)", "Unknown (Error)", "Unknown"] else "---"
            grouped_results[result['äººç‰©å']].append(result)

        # å…¨ã¦ã®çµæœã‚’æ ¼ç´ã™ã‚‹Flet Column
        all_sections = ft.Column()

        for name, group in grouped_results.items():
            
            section_title = ft.Text(f"ğŸ‘¤ {name} ({len(group)} å€‹ã®é¡”ã‚’æ¤œå‡º)", size=18, weight=ft.FontWeight.BOLD)
            all_sections.controls.append(section_title)
            
            # ç”»åƒã‚’æ¨ªã«ä¸¦ã¹ã‚‹Row
            image_row = ft.Row(wrap=True, spacing=10)
            
            for result in group:
                
                image_np = result.get('ç”»åƒãƒ‡ãƒ¼ã‚¿')
                face_location = result.get('é¡”åº§æ¨™')
                
                cropped_face = None
                
                if image_np is not None:
                    try:
                        # ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã®å‡¦ç† (é¡”ã®åˆ‡ã‚ŠæŠœã)
                        image_pil = Image.fromarray(image_np)
                        if face_location:
                            top, right, bottom, left = face_location
                            padding = 50
                            
                            img_width, img_height = image_pil.size
                            crop_area = (
                                max(0, left - padding), max(0, top - padding), 
                                min(img_width, right + padding), min(img_height, bottom + padding)
                            )
                            cropped_face = image_pil.crop(crop_area)
                        else:
                            # é¡”ãªã—ã®å ´åˆã€å…ƒã®ç”»åƒã‚’ãƒªã‚µã‚¤ã‚º
                            cropped_face = image_pil.resize((150, 150))
                            
                        # PILç”»åƒã‚’ãƒã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›ã—ã€Fletã®Imageã«æ¸¡ã™
                        if cropped_face:
                            buffer = BytesIO()
                            # ç”»è³ªã‚’èª¿æ•´ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ (ä»»æ„)
                            cropped_face.save(buffer, format="JPEG", quality=85) 
                            # ğŸš¨ ä¿®æ­£ç‚¹ 1: hex() ã§ã¯ãªã Base64 ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹
                            base64_bytes = base64.b64encode(buffer.getvalue())
                            # ä¿®æ­£: MIMEã‚¿ã‚¤ãƒ—ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
                            base64_data = f"data:image/jpeg;base64,{base64_bytes.decode('utf-8')}"
                            

                            base64_img = ft.Image(src_base64=base64_data, width=150, height=150, fit=ft.ImageFit.CONTAIN)
                            # ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
                            caption_text = ft.Text(f"{result['ãƒ•ã‚¡ã‚¤ãƒ«å']}\n{result['ä¿¡é ¼åº¦_str']}", size=12, text_align=ft.TextAlign.CENTER)
                            
                            # ç”»åƒã¨ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¸€ã¤ã®Cardã«ã¾ã¨ã‚ã‚‹
                            card = ft.Container(
                                content=ft.Column([base64_img, caption_text], horizontal_alignment=ft.CrossAxisAlignment.CENTER, spacing=5),
                                width=180,
                                padding=5,
                                alignment=ft.alignment.top_center
                            )
                            image_row.controls.append(card)
                        
                    except Exception as img_ex:
                         # ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
                        print(f"ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼: {img_ex}")


            all_sections.controls.append(image_row)
            all_sections.controls.append(ft.Divider()) # ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®åŒºåˆ‡ã‚Šç·š

        results_container.controls.append(all_sections)
        
        end_time = datetime.datetime.now()
        results_container.controls.append(ft.Text(f"å‡¦ç†æ™‚é–“: {end_time - start_time:.2f}ç§’"))
        
        page.update()
        

    # Fletã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ”ãƒƒã‚«ãƒ¼ (ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ç”¨)
    file_picker = ft.FilePicker(on_result=file_picker_result)
    page.overlay.append(file_picker)
    

    # --- 7. UIã®æç”» ---

    # ãƒ˜ãƒƒãƒ€ãƒ¼ã¨è¨­å®šæƒ…å ±
    main_column = ft.Column(
        [
            ft.Row([
                ft.Text("æ¤œè¨¼ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨è­˜åˆ¥", size=24, weight=ft.FontWeight.BOLD),
                ft.Text(f"å­¦ç¿’äººæ•°: {len(le.classes_)}äºº, ã—ãã„å€¤: {CONFIDENCE_THRESHOLD*100:.0f}%", size=14, color=ft.Colors.BLUE_GREY_400)
            ], alignment=ft.MainAxisAlignment.SPACE_BETWEEN),
            ft.Divider(),
            # æ¤œè¨¼ãƒœã‚¿ãƒ³ï¼ˆFilePickerã‚’å‘¼ã³å‡ºã™ï¼‰
            ft.Container(
                content=ft.ElevatedButton(
                    # ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿®æ­£: ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã«é–¢ã™ã‚‹è¨€åŠã‚’å‰Šé™¤
                    "ğŸ“‚ æ¤œè¨¼å¯¾è±¡ã®ç”»åƒã‚’é¸æŠ", 
                    icon=ft.Icons.UPLOAD_FILE,
                    on_click=lambda _: file_picker.pick_files(),
                ),
                padding=ft.padding.all(10),
                bgcolor=ft.Colors.LIGHT_BLUE_50
            ),
            ft.Divider(),
            ft.Text("ğŸ¯ è­˜åˆ¥çµæœ", size=20, weight=ft.FontWeight.BOLD),
            results_container # çµæœã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ
        ],
        scroll=ft.ScrollMode.AUTO,
        expand=True,
    )

    """ main_drop_container = ft.Container(
        content=main_column,
        expand=True,
        on_drop=lambda e : file_picker_result(e),
    ) """

    page.add(main_column)

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
if __name__ == "__main__":
    ft.app(target=main)